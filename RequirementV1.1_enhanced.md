# 个人镜像系统 v3.0 - 深化需求与落地分析

> 文档版本: v3.3  
> 基于: RequirementV1.1.md  
> 目标平台: Nanobot Agent (nanobot-webui)  
> 生成时间: 2025-02-13  
> 更新说明: v3.3 新增「镜室」独立 Tab、赏/悟/辩/吾 四子页布局与交互规格

---

## 一、需求优化与可行性总览

### 1.1 原需求 vs 当前 Nanobot 能力映射

| 需求模块 | 核心能力要求 | Nanobot 现状 | 可行性 | 差距说明 |
|---------|-------------|---------------|--------|----------|
| **悟** | 结束悟道按钮、会话封存、定时任务、按日 MD 存储 | 有对话历史、LLM、bootstrap | **高** | 缺：结束按钮、封存状态、定时任务、wu 文件结构 |
| **辩** | 结束辩论按钮、会话封存、同悟逻辑 | 有 Session 历史(50条)、Memory | **高** | 同上 |
| **赏** | 图像 A/B 选择、Qwen-Image 文生图 | 有文本对话、支持图片输入 | **中** | 缺：Qwen-Image API、A/B 选择 UI |
| **镜** | 周汇总、融合画像、变化追踪 | 有 Memory、无定时任务 | **中** | 缺：结构化档案存储、周触发、变化对比 |

### 1.2 落地路线建议

**Phase 1（MVP）**：悟 + 辩（结束按钮 + 封存 + 定时任务 + 按日 MD）  
- 新增「结束悟道」「结束辩论」按钮及会话封存逻辑  
- 系统定时任务：非当日未封存会话自动触发分析  
- 悟写入 `mirror/wu/YYYY-MM-DD.md` + `mirror/wu/MEMORY.md`；辩同理  

**Phase 2**：赏模块图像化（Qwen-Image）  
- 集成阿里云 DashScope Qwen-Image 文生图 API  
- 前端 A/B 图片选择组件  

**Phase 3**：镜模块自动化  
- 周定时任务、变化追踪、导出/导入  

---

## 二、镜室 - 整体架构与导航（用户需求 v3.3）

### 2.0 镜室入口与布局

**导航结构**

- 在侧边栏（与「聊天」「配置」「系统」同级）新增 **镜室** Tab
- 路由：`/mirror`，进入后为镜室专属页面

**镜室页面结构**

```
┌─────────────────────────────────────────────────────────┐
│  镜室                                                    │
├─────────────────────────────────────────────────────────┤
│  [赏]  [悟]  [辩]  [吾]   ← 顶部四子 Tab，横向排列        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  根据当前子 Tab 显示对应内容区                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**四子 Tab 说明**

| Tab | 含义 | 核心功能 |
|-----|------|----------|
| 赏 | 审美直觉投射 | 每日一次 A/B 图选择，记录可查看 |
| 悟 | 语言层深度剖析 | 悟一下 → 新会话，AI 给命题或自由发挥 |
| 辩 | 认知压力测试 | 同悟，支持攻击强度配置 |
| 吾 | 自我多维画像 | 只读展示，融合悟/辩/赏的镜输出 |

---

### 2.0.1 赏 Tab - 页面布局与交互

**布局**：左栏记录列表 + 右/中内容区

**状态 A：当日已赏过**

- **左侧**：显示当日及历史赏记录列表（日期、主题、选择、归因摘要）
- **右侧/中央**：显示当前选中记录的详情（A/B 图、选择、归因、分析结论）
- 无输入，仅查看

**状态 B：当日未赏过**

- **左侧**：空或显示历史记录（灰色/不可选今日）
- **右侧/中央**：
  1. 系统自动开始生成：根据命题矩阵生成 2 张图（Qwen-Image）
  2. **生成中**：展示 Loading（骨架屏或 Spinner）
  3. **生成完成**：并排展示 A、B 图，提供「选 A」「选 B」按钮
  4. 用户选择后，LLM 追问「为什么选这个？」
  5. 用户回答后，生成分析记录并写入 `mirror/shang/`

**记录结构**：每条记录含 主题、时间、选项A/B图、用户选择、归因、荣格/大五推断

---

### 2.0.2 悟 Tab - 页面布局与交互

**布局**：左栏悟会话列表 + 右/中内容区

**空态（无进行中会话）**

- **左侧**：历史悟会话列表（日期、主题摘要、核心洞察）
- **中央**：空白页，中央放置 **Logo +「悟一下」** 按钮
  - 点击后开启新悟会话
  - AI 首次回复：给出 **三个悟命题**（如：工作驱动力 / 情绪表达 / 人际关系，或三个开放式引导问题）供用户选择；或提示「也可直接说你此刻想聊的」

**进行中**

- **左侧**：当前会话 + 历史列表
- **右侧**：对话区（与 ChatPage 类似，悟道专用会话）
- 底部有「结束悟道」按钮，点击后触发分析、封存、写入 wu

---

### 2.0.3 辩 Tab - 页面布局与交互

**布局**：与悟类似，左栏辩会话列表 + 右/中内容区

**空态**

- **中央**：Logo +「辩一下」按钮
- **配置区**（在点击前或弹窗内）：
  - **本轮攻击强度**：
    - 轻度：友善追问，点到为止
    - 中度：举例反例，适度施压
    - 强度：直指双标与矛盾，犀利追问
  - 其他可选：辩题预设、主题范围（工作/情感/价值观等）

**进行中**

- 左侧：当前辩会话 + 历史
- 右侧：对话区
- 底部：「结束辩论」按钮

---

### 2.0.4 吾 Tab - 页面布局与交互

**布局**：单页只读展示，无左右分栏

**内容**：对用户的多维度描述（镜模块融合输出）

- 大五人格推断
- 荣格原型
- 深层驱动力
- 核心矛盾
- 行动建议
- 变化追踪（如有历史快照）

**无输入**：本页纯展示，不提供输入框或按钮（除刷新、导出等辅助操作）

**数据来源**：`mirror/profile.json` 或 `mirror/snapshots/` 最新融合结果；若无数据则展示空态提示「尚未生成镜像，先完成悟/辩/赏与镜融合」

---

## 三、悟模块 - 结束悟道 + 封存 + 定时任务（用户需求 v3.2）

### 3.1 核心交互逻辑

**「结束悟道」按钮**

- 用户点击「结束悟道」后：
  1. **触发悟分析**：对当前会话的完整对话进行叙事/防御机制分析
  2. **会话封存**：该会话进入「只读」状态，不能再发送新消息
  3. **持久化**：分析结果写入 `mirror/wu/YYYY-MM-DD.md`（按日期划分）
  4. **汇总**：同时追加到 `mirror/wu/MEMORY.md`（悟总档案）

**重新悟道**：必须开启**新对话**才能开始新的悟道流程，避免同一会话多次触发悟分析。

### 3.2 悟模块数据存储

```
workspace/mirror/wu/
  YYYY-MM-DD.md    # 按日期划分，当日多轮悟分析追加到同文件
  MEMORY.md        # 悟总档案，所有悟分析的汇总
```

**YYYY-MM-DD.md 示例**：

```markdown
## 2025-02-13

### 悟分析 #1 (14:32)
**会话ID**: web:xxx
**对话切片**: [摘录]
**叙事结构**: 第一人称 / 过去倾向
**防御机制**: 合理化、投射
**潜意识关键词**: 应该、必须、没办法
**核心洞察**: 习得性无助
```

**MEMORY.md**：表格或列表形式的汇总索引，便于镜模块与跨会话引用。

### 3.3 悟模块 - 系统定时任务

**触发条件**：非当日的会话（昨日及更早的悟道会话）

**执行逻辑**：
1. 扫描所有**未封存**且**非当日创建**的悟道会话
2. 对每个会话自动触发悟分析
3. 将分析结果写入对应日期的 `mirror/wu/YYYY-MM-DD.md`
4. 将会话标记为封存

**调度**：每日凌晨 1:00 执行（可配置）

---

## 三、辩模块 - 结束辩论 + 封存 + 定时任务（用户需求 v3.2）

### 3.1 与悟模块相同的逻辑

- **「结束辩论」按钮**：点击后触发辩分析、封存会话、写入 `mirror/bian/YYYY-MM-DD.md` 和 `mirror/bian/MEMORY.md`
- **重新辩论**：必须开启新对话
- **系统定时任务**：非当日未封存的辩论会话，自动触发辩分析并封存

### 3.2 辩模块数据存储

```
workspace/mirror/bian/
  YYYY-MM-DD.md    # 按日期划分
  MEMORY.md        # 辩总档案（含立场摘要，供镜模块与跨会话引用）
```

### 3.3 辩模块分析内容

写入 MD 时包含：辩题、用户立场、检测到的矛盾、逻辑谬误、暴露的价值观等（沿用 RequirementV1.1 的 JSON 结构，转为可读 MD）。

---

## 四、赏模块 - Qwen-Image 文生图集成（用户需求 v3.2）

### 4.1 技术选型：阿里云 DashScope Qwen-Image

| 项目 | 说明 |
|------|------|
| 模型 | `qwen-image-max`（推荐）或 `qwen-image-plus` |
| 平台 | 阿里云百炼 Model Studio / DashScope |
| API | `POST .../api/v1/services/aigc/multimodal-generation/generation` |
| 鉴权 | `DASHSCOPE_API_KEY`（与现有 Qwen 对话模型可共用） |
| 输出 | PNG 单张图像 |

**优势**：擅长复杂文本渲染、多艺术风格，与通义千问生态统一，国内可用。

### 4.2 赏模块流程（图像版）

1. **命题**：根据当前分析主题，生成 2 张风格迥异的图片描述（prompt）
2. **调用 Qwen-Image**：对 A、B 各生成一张图
3. **前端展示**：并排显示 A、B 图片，提供「选 A」「选 B」按钮
4. **归因追问**：用户选择后，LLM 追问「为什么选这个？」
5. **分析输出**：结合选择与归因，输出赏分析 JSON，写入 `mirror/shang/`

### 4.3 配置与工具

- 复用或新增 DashScope 配置，需支持 `qwen-image-*` 模型
- 新增 `image_generate` 工具：`prompt`, `size?`, `style?`

---

## 五、镜模块

**现状**：  
- 无定时任务框架（虽有 `CronTool`，但需用户触发）  
- Memory 为线性列表，无「周目」「变化追踪」结构  

**不足与改进**：

| 不足 | 改进方案 |
|------|----------|
| 「每周汇总」无自动化 | 方案 A：利用现有 `memory_maintenance` 日合并逻辑，增加「周镜」分支<br>方案 B：新增后台服务，按 cron 触发镜融合任务<br>方案 C：用户说「生成本周镜像」时手动触发 |
| 数据来源分散 | 统一从 `workspace/mirror/` 读取：`wu/*.json`、`bian/*.json`、`shang/*.json` |
| 变化追踪需历史快照 | 每次镜融合时，将 `big_five` 等写入 `mirror/snapshots/YYYY-Www.json`，下次对比 |
| 融合算法未定义 | 在 prompt 中明确：对悟/辩/赏的 JSON 做「扎根编码」式归纳，输出大五、原型、驱动力、矛盾、建议 |

**建议**：MVP 用手动触发（方案 C）；后续用方案 B 做周定时任务。

---

## 六、技术实现规格（深化）

### 6.1 数据存储结构（v3.2 更新）

```
workspace/mirror/
  wu/
    YYYY-MM-DD.md    # 悟 - 按日期
    MEMORY.md        # 悟总档案
  bian/
    YYYY-MM-DD.md    # 辩 - 按日期
    MEMORY.md        # 辩总档案（含立场摘要）
  shang/             # 赏模块记录（JSON 或 MD）
    YYYY-MM-DD_xxx.json
  snapshots/         # 镜模块快照（变化追踪）
    YYYY-Www.json
  profile.json       # 最新综合画像
```

### 6.2 新增工具规格

| 工具名 | 用途 | 参数 |
|--------|------|------|
| `record_mirror` | 持久化悟/辩/赏/镜的 JSON 或 MD | `module: str`, `data: dict` |
| `read_mirror` | 读取指定模块/时间范围的数据 | `module: str`, `since: str?`, `limit: int?` |
| `image_generate` | 调用 Qwen-Image 文生图（赏模块） | `prompt: str`, `size?: str`, `style?: str` |
| `trigger_mirror_fusion` | 触发镜模块融合（可选） | 无 |

### 6.3 会话类型与前端（v3.3 更新）

- **镜室**：独立 Tab `/mirror`，内含赏/悟/辩/吾 四子页
- **悟/辩会话**：在镜室-悟、镜室-辩 内创建，不再依赖主聊天侧边栏
- **会话类型**：悟道 | 辩论；封存后只读，结束按钮触发分析并写入对应 mirror 目录

### 6.4 路由与 API（v3.3）

| 前端路由 | 说明 |
|----------|------|
| `/mirror` | 镜室主页，默认子 Tab 可为赏或吾 |
| `/mirror/shang` | 赏子页 |
| `/mirror/wu` | 悟子页 |
| `/mirror/bian` | 辩子页 |
| `/mirror/wo` | 吾子页（吾 = 自我画像） |

**建议 API**（后端需新增或扩展现有）：

- `GET /api/mirror/shang/today` - 今日是否已赏、记录概要  
- `GET /api/mirror/shang/records` - 赏历史记录列表  
- `POST /api/mirror/shang/start` - 开始当日赏（触发图像生成）  
- `POST /api/mirror/shang/choose` - 提交 A/B 选择及归因  
- `GET /api/mirror/wu/sessions` - 悟会话列表  
- `POST /api/mirror/wu/start` - 悟一下，开新会话  
- 辩同理  
- `GET /api/mirror/profile` - 吾画像（profile.json 内容）  

### 6.5 Skill 结构

```
nanobot/skills/mirror-system/
  SKILL.md          # 主技能：悟/辩/赏/镜流程与 prompt
  references/
    wu-prompts.md   # 悟模块 prompt 片段
    bian-prompts.md # 辩模块 prompt 片段
    shang-prompts.md# 赏模块 prompt 片段
    jing-prompts.md # 镜模块 prompt 片段
```

### 6.6 Bootstrap 集成

在 `AGENTS.md` 或新建 `MIRROR.md` 中注入：

- 角色设定：Nanobot 同时担任个人镜像系统助手  
- 四模块触发规则（何时悟、何时辩、何时赏、何时镜）  
- 输出格式约定（JSON 块 + 自然语言解读）  

---

## 七、风险与伦理考量

### 7.1 风险

| 风险 | 缓解措施 |
|------|----------|
| 心理分析引发不适 | 在首轮说明「本分析仅供参考，不替代专业咨询」；攻击力度可调 |
| 数据隐私 | 所有数据存于本地 workspace，不云端上传（与现有 Memory 一致） |
| LLM 分析稳定性 | 悟/辩/赏输出加 `confidence` 字段；低置信度时标注「待更多数据」 |
| 赏模块文字版效度 | 明确标注「文字版为简化测试」；完整版需图像支持 |

### 7.2 伦理边界

- 不给出「诊断」类结论，仅描述模式与倾向  
- 行动建议限于「自我探索」「反思」「记录」等，不涉及医疗建议  

---

## 八、修正与优化后的需求要点

### 8.1 文档中的修正建议

1. **4.2 理论依据**  
   - 原文「4.荣格人格类型学」应为「4.2.1」；「2.1」应为「4.2.1」——修正编号错误。

2. **赏模块图像**  
   - v3.2 确定采用 Qwen-Image（阿里云 DashScope）文生图，直接实现图像版。

3. **数据流**  
   - 原「用户输入 -> Nanobot分析 -> MD文档记录」建议改为：  
     `用户输入 -> Nanobot分析 -> record_mirror 写入 JSON -> 镜融合读取 JSON -> 生成 MD/画像`  
   - 明确 JSON 为中间格式，MD 为可读展示。

4. **下一步行动**  
   - 原「将本文档保存到 E:\workSpace\...」改为 `workspace/mirror/` 下的路径，与 Nanobot workspace 统一。  
   - 「从赏模块开始」改为「从悟+辩开始」（赏依赖图像，MVP 可后置）。

### 8.2 实施优先级（建议，v3.3）

1. **镜室入口**：新增 `/mirror` 路由、侧边栏「镜室」、MirrorPage 容器  
2. **四子 Tab**：赏/悟/辩/吾 顶部 Tab、各子页骨架  
3. **吾 Tab**：只读展示 `profile.json`，空态提示  
4. **赏 Tab**：左栏记录、当日未赏时生成+Loading、A/B 选择、Qwen-Image  
5. **悟 Tab**：「悟一下」入口、新会话、三命题/自由发挥、结束悟道、左栏历史  
6. **辩 Tab**：同悟，「辩一下」+ 攻击强度配置、结束辩论  
7. **悟/辩定时任务**：非当日未封存会话自动触发分析  
8. **镜模块**：周汇总、变化追踪  

---

## 九、附录：与 RequirementV1.1 的对应关系

本深化文档对原需求文档的改动汇总：

- **保留**：四模块理论、心理学依据、JSON 输出格式、Prompt 集、MD 模板  
- **v3.2**：悟/辩采用「结束按钮 + 封存 + 定时任务 + 按日 MD」；赏采用 Qwen-Image  
- **v3.3**：镜室独立 Tab、赏/悟/辩/吾 四子页布局、吾为只读画像展示  

原文档的 Prompt 集可直接纳入 `mirror-system/references/` 使用，无需大改。

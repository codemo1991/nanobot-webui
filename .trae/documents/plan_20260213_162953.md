## 配置迁移到SQLite的方案

### 一、SQL Schema设计

在现有 `~/.nanobot/chat.db` 中新增配置相关表：

```sql
-- 1. 核心配置表 (键值对，支持分组)
CREATE TABLE config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    category TEXT NOT NULL,        -- 分类: 'agent', 'gateway', 'mirror'
    key TEXT NOT NULL,             -- 配置键
    value TEXT NOT NULL,           -- 配置值 (JSON或字符串)
    value_type TEXT DEFAULT 'str', -- 值类型: 'str', 'int', 'float', 'bool', 'json'
    updated_at TEXT NOT NULL,
    UNIQUE(category, key)
);

-- 2. Provider配置表 (敏感信息单独存储)
CREATE TABLE config_providers (
    id TEXT PRIMARY KEY,           -- 'anthropic', 'openai', 'deepseek' 等
    name TEXT NOT NULL,            -- 显示名称
    api_key TEXT DEFAULT '',       -- API密钥 (敏感)
    api_base TEXT,                 -- API基础URL
    enabled INTEGER DEFAULT 0,     -- 是否启用
    priority INTEGER DEFAULT 0,    -- 优先级排序
    updated_at TEXT NOT NULL
);

-- 3. Channel配置表
CREATE TABLE config_channels (
    id TEXT PRIMARY KEY,           -- 'whatsapp', 'telegram', 'feishu' 等
    enabled INTEGER DEFAULT 0,
    config_json TEXT NOT NULL,     -- 其他配置JSON (token, bridgeUrl, allowFrom等)
    updated_at TEXT NOT NULL
);

-- 4. MCP服务器配置表
CREATE TABLE config_mcps (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    transport TEXT DEFAULT 'stdio',
    command TEXT,
    args_json TEXT DEFAULT '[]',   -- JSON数组
    url TEXT,
    enabled INTEGER DEFAULT 1,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);

-- 5. 工具配置表
CREATE TABLE config_tools (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tool_type TEXT NOT NULL,       -- 'web', 'exec', 'filesystem'
    key TEXT NOT NULL,
    value TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    UNIQUE(tool_type, key)
);

-- 索引
CREATE INDEX idx_config_category ON config(category);
CREATE INDEX idx_config_providers_enabled ON config_providers(enabled);
CREATE INDEX idx_config_channels_enabled ON config_channels(enabled);
```

### 二、默认Workspace修改

将 `schema.py` 中 `AgentDefaults.workspace` 默认值改为：
```python
workspace: str = "~/.nanobot/web-ui"
```

### 三、实现步骤

1. **创建** **`ConfigRepository`** **类** (`nanobot/storage/config_repository.py`)
   * 实现 CRUD 操作
   * 支持从 JSON 迁移数据
   * 支持回退到 JSON 文件

2. **修改** **`ConfigLoader`** (`nanobot/config/loader.py`)
   * 添加 SQLite 优先加载逻辑
   * 保留 JSON 文件兼容性
   * 自动迁移旧配置

3. **修改** **`save_config`** **函数**
   * 写入 SQLite 数据库
   * 可选保留 JSON 文件同步

4. **修改 Web API** (`nanobot/web/api.py`)
   * 更新配置读写逻辑
   * 支持热重载

### 四、数据迁移策略

1. 首次启动时检测 SQLite 是否有配置
2. 若无，从 `config.json` 迁移
3. 迁移后保留 JSON 文件作为备份
4. 后续所有读写操作使用 SQLite

### 五、文件结构

```
nanobot/
├── storage/
│   ├── config_repository.py  (新增)
│   └── status_repository.py  (现有)
├── config/
│   ├── loader.py             (修改)
│   └── schema.py             (修改默认workspace)
```

### 六、优势

* **高效查询**: 索引优化，按分类/启用状态快速筛选
* **安全存储**: API Key 单独存储，便于加密扩展
* **原子更新**: SQLite 事务保证一致性
* **向后兼容**: 自动迁移，无缝升级
* **统一管理**: 与会话数据共用同一数据库